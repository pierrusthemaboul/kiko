# Analytics & Measurement Audit

## Instrumentation Inventory
| Path:Line | Category | Events / Properties | Notes |
| --- | --- | --- | --- |
| lib/firebase.ts:1-420 | Firebase Analytics wrapper | Central export `FirebaseAnalytics` wraps modular API: `initialize` sets `userId` and props (`is_guest`, `app_version`, `platform`); trackers emit `game_started`, `level_started`, `level_completed`, `question_answered`, `streak_achieved`, `game_over`, `reward_earned`, `ad_event`, `error_occurred`, `leaderboard_viewed`, `disclaimer_viewed`, `new_high_score`, `app_backgrounded`/`app_foregrounded`; `logCustomEvent` sanitizes params | Single analytics singleton; errors funnelled via `error_occurred`; no Crashlytics/Performance hooks despite mentions; relies on module-scope `getAnalytics()` |
| hooks/game/useAnalytics.ts:1-168 | Analytics helper hook | Provides memoized callbacks mapping gameplay, ad, error, and user-property events to `FirebaseAnalytics` methods | Thin wrapper duplicates API surface; schema changes require updates here and in call sites |
| app/_layout.tsx:65-151 | App lifecycle + AdMob setup | Initializes analytics (`initialize`, `appOpen`), logs `app_update`; emits `error_occurred` with codes `app_initialization_error`, `auth_get_session_error`, `admob_config_warning`, `admob_init_error`; calls `setAdPersonalization(canShowPersonalizedAds)` | Consent hook currently disabled (`canShowPersonalizedAds=false`), so Ads SDK always non-personalized; MobileAds init failures logged only via analytics |
| hooks/useAdConsent.ts:1-118 | Consent (UMP) | Uses `AdsConsent.requestInfoUpdate`, optionally `AdsConsent.showForm`; exposes `consentStatus`, `canShowPersonalizedAds`, `resetConsent` | Consent state kept in memory; no analytics logging of outcomes; result not persisted nor forwarded when `_layout` overrides personalization flag |
| lib/config/adConfig.ts:1-78 | Ad personalization config | `setAdPersonalization` toggles module flag; `getAdRequestOptions` returns `requestNonPersonalizedAdsOnly`; `getAdUnitId` selects test/prod unit IDs | Request options currently always non-personalized due to upstream flag; no analytics emitted |
| app/(tabs)/index.tsx:323-575 | Home funnel + banner ad | Screen `Home`; events `splash_complete`, `user_login`, `user_logout`, `guest_login`, `guest_mode_confirmed`, `guest_to_signup`, `start_game_button_clicked`, `login_button_clicked`, `signup_button_clicked`; sets user prop `display_name`; banner ads logged via `FirebaseAnalytics.ad('banner', action, 'home_banner', 0)`; errors mapped to `session_check_error`, `profile_fetch_error`, `logout_error`, `ad_load_failed` | Multiple `FirebaseAnalytics.initialize` calls per auth check; logout event schema differs from Vue1; banner configured as non-personalized regardless of consent |
| app/(tabs)/vue1.tsx:72-118 | Authenticated hub | Screen `HomeLuxury`; emits `user_logout` with `from_screen`; logs `logout_error` on failure | Shares `user_logout` name with home but different params; no success metric for rewarded extra play CTA |
| app/auth/login.tsx:65-258 | Login flow tracking | Screen `Login`; emits `login_attempt` (password/google), multiple `login_failed` reasons (`supabase_error`, `invalid_credentials`, `google_oauth_error`, `google_no_url`, `google_exchange_failed`, `google_cancelled`, `google_unexpected_error`, `unexpected`), successes via `login` (`method`), navigation `navigate_to_signup`; reinitializes analytics on success | `login_failed` payload varies (some include truncated `message`, others omit), complicating schema; no Crashlytics capture for errors |
| app/auth/signup.tsx:62-321 | Signup flow tracking | Screen `SignUp`; events `signup_attempt` (password/google), `signup_failed` with granular reasons, `sign_up` methods (`password`, `password_email_confirmation_pending`, `google`); analytics reinit on success | Similar schema variance across `signup_failed`; no linkage to consent acceptance or downstream engagement |
| app/game/GameScreen.tsx:92-276 | Screen tracking | Focus hooks log `GameScreen` and `PrecisionGameScreen` views | Relies on nested hooks for gameplay telemetry; no guarding against duplicate focus events |
| hooks/game/usePrecisionGame.ts:621-842 | Precision gameplay metrics | Custom events `precision_guess`, `precision_timeout`, `precision_app_backgrounded`, `precision_game_over`, `precision_continue_declined`, `precision_continued`; payloads include `event_id`, `level`, `abs_difference`, HP/score deltas | Background penalty also logged via `useAppStateDetection`, risking duplicates; no analytics when HP drops to 0 before logging |
| hooks/game/useAppStateDetection.ts:45-74 | App state watch | Logs `app_backgrounded_during_game` with `event_id`, `previous_state`, `next_state` before invoking penalty | Additional background logs exist in other hooks, so counts may double; no sampling/backoff |
| hooks/game/useEventSelector.ts:353-425 | Event selection telemetry | Emits `error_occurred` (`invalid_selection_params`) on missing data; logs `temporal_jump` with `from_year`, `to_year`, `jump_distance`, `jump_direction`, `user_level` | No throttling on error logging; `temporal_jump` only fires on forced jumps so may be sparse |
| hooks/game/usePrecisionAds.ts:69-224 | Precision ad flow | `FirebaseAnalytics.ad` tracks `precision_game_over`/`precision_continue` actions (`loaded`, `failed`, `opened`, `closed`, `closed_without_reward`, `earned_reward`, `triggered`); `FirebaseAnalytics.reward('CONTINUE_PRECISION', ...)`; errors via `ad_show_error` | Ads requested with `requestNonPersonalizedAdsOnly: true`; no revenue/impression metrics; continue behaviour flagged only boolean |
| hooks/game/useAds.ts:319-806 | Core ad management | High-volume `ad_event` logs for placements `generic`, `level_up`, `game_over`, `extra_life` (actions: `loaded`, `failed`, `opened`, `closed`, `triggered`, `not_available`, `blocked`, `error_show`, `request_display`, `closed_without_reward`, `earned_reward`); `FirebaseAnalytics.reward` for extra life; errors `ad_load_error`, `rewarded_resume_error`, `ad_show_error`, `ad_reset_reload_error` | No differentiation between ad networks; some analytics calls made inside catch blocks without awaiting; placement strings overlap with precision module |
| hooks/useRewardedPlayAd.ts:62-146 | Rewarded extra play ads | Logs `ad_event` for `extra_play` (loaded/failed/opened/closed/earned_reward/triggered); `FirebaseAnalytics.reward('EXTRA_PLAY', ...)`; error `ad_show_error` | Placement string only distinguisher; no state for reward throttling analytics |
| hooks/useRewards.ts:235-245 | In-game reward tracking | Emits `FirebaseAnalytics.reward(reward.type, reward.amount, trigger.type, triggerValue, level, points)` during streak/level rewards | Dynamic string params (e.g. `streak-5`) may explode event cardinality; no success confirmation analytics |
| hooks/useAudio.ts:45-142 | Audio telemetry | Logs `sound_played` for key effects, `sound_toggled` for effects/music; errors `audio_init_error`, `audio_playback_error`, `audio_volume_error` | Only a subset of sounds produce analytics; repeated failures spam `error_occurred` with truncated messages |
| hooks/game/usePrecisionAudio.ts:52-131 | Precision audio telemetry | Emits `precision_sound_played` for notable results; errors `precision_audio_init_error`, `precision_audio_playback_error` | Separate event namespace from generic audio; duplicates stateful logging logic |
| hooks/game/useInitGame.ts:100-251 | Game init analytics | On profile load logs `profile_fetch_error`, `unexpected_fetch_user`, `game_initialization`; sets user prop `display_name`; emits `game_started`, `level_started` once initialization completes | Uses `setTimeout` to fire analytics, risking race if component unmounts; guest detection uses empty name heuristic |
| hooks/useGameLogicA.ts:251-1121 | Classic game loop telemetry | Events `timeout`, multiple `life_lost` cases (with `reason`, `remaining_lives`, `level_id`, `event_id`), `app_backgrounded_during_game`, `reward_applied`, `new_high_score`; leaderboard via `FirebaseAnalytics.leaderboard('summary_loaded')`; extensive error codes (`timeout_null_event`, `apply_reward_error`, `select_event_null_levelup`, etc) | Duplicates background/penalty events emitted elsewhere; `life_lost` schema varies per branch; no Crashlytics fallback |
| hooks/useGameLogicA.refactored.ts:130-718 | Alternate game loop (refactor) | Mirrors `timeout`, `life_lost`, `new_high_score`, ad triggers, leaderboard logging, and numerous error codes | Appears unused but kept alongside main hook, risking divergent analytics if both referenced |
| app/(tabs)/index.tsx banner section:563-575 | Banner ad callbacks | `FirebaseAnalytics.ad('banner', 'loaded'/'failed', 'home_banner', 0)`; `FirebaseAnalytics.error('ad_load_failed', ...)` | Hardcoded level `0`; no impression revenue capture |
| hooks/game/usePrecisionGame.ts auto-continue:820-843 | Continue flow analytics | `FirebaseAnalytics.logEvent('precision_continue_declined', { score })`; `FirebaseAnalytics.logEvent('precision_continued', { score, hp_restored })` | Continue reward amount fixed; no event for failed rewarded load |
| hooks/game/useAppStateDetection.ts penalty:45-74 | Background penalty trigger | Logs `app_backgrounded_during_game` before invoking timeout logic | Combined with precision hook penalty logging |
| hooks/game/useEventSelector.ts forced jump:373-425 | Difficulty instrumentation | `temporal_jump` parameters capture jump direction/distance | Event frequency tied to forced jump counter |
| app/_layout.tsx auth listener:133-151 | Session analytics | `FirebaseAnalytics.initialize(session?.user?.id, !session)` on auth change; errors `auth_get_session_error` | Initialization repeated on every auth event |
| app/(tabs)/index.tsx guest flow:423-452 | Guest funnel | Events `guest_login`, `guest_mode_confirmed`, `guest_to_signup`; reinitialize analytics as anonymous | Guest IDs pseudo-random; no property capturing consent |
| app/auth/login.tsx Google flow:145-247 | OAuth analytics | `login_failed` reasons for Google-specific failures; success `login` (method `google`) | Event counts sensitive to OAuth retries; same event name covers multiple failure modalities |
| app/auth/signup.tsx Google flow:214-319 | OAuth signup analytics | `signup_failed` reasons for Google failures; success `sign_up` (method `google`) | No linkage between signup attempt and subsequent login events |
| hooks/game/usePrecisionAds.ts rewarded:108-162 | Rewarded continue analytics | `FirebaseAnalytics.ad('rewarded', 'loaded'/'failed'/'opened'/'closed_without_reward'/'earned_reward', 'precision_continue', 0)`; `FirebaseAnalytics.reward('CONTINUE_PRECISION', ...)` | Continue reward flagged only boolean; no measurement of watch duration |
| hooks/useRewardedPlayAd.ts listeners:62-108 | Rewarded play instrumentation | Parallel to precision ad but placement `extra_play`; reward logged via `FirebaseAnalytics.reward` | Shared singleton across hooks; state managed via module-scope flags |
| hooks/game/useAds.ts pending display:683-770 | Pending ad analytics | `FirebaseAnalytics.ad(..., 'error_show'/'request_display'/'blocked')` for pending interstitial/rewarded show attempts | Placement string reused in multiple contexts; potential schema ambiguity |
| hooks/useRewards.ts trigger:235-245 | Reward analytics | `FirebaseAnalytics.reward` called with dynamic trigger descriptors (`streak-X`, `level-Y`) | Potential high cardinality due to stringified triggers |
| hooks/useAudio.ts toggles:137-142 | Audio preference analytics | `FirebaseAnalytics.logEvent('sound_toggled', { enabled, type })` for effects/music | No corresponding event for initial state; type naming inconsistent with other events |
| hooks/game/usePrecisionAudio.ts result sounds:127-131 | Result sound analytics | `precision_sound_played` for `perfectAnswer`, `wrongAnswer`, etc | Event fired only on certain keys; duplicates general `sound_played` semantics |
| hooks/game/useInitGame.ts analytics:235-236 | Game start analytics | `FirebaseAnalytics.gameStarted`, `FirebaseAnalytics.levelStarted` seeded on init | Guest detection uses absence of name; may misclassify returning players without display name |
| hooks/useGameLogicA.ts leaderboard:826 | Leaderboard analytics | `FirebaseAnalytics.leaderboard('summary_loaded')` when leaderboards fetched | No analytics for individual leaderboard requests/failures beyond this point |
| hooks/useGameLogicA.ts errors:295-1234 | Error telemetry | Extensive `FirebaseAnalytics.error` codes covering timeout, resume, leaderboard, level-up branches | All mapped to `error_occurred`; severity not distinguished |
| hooks/useGameLogicA.refactored.ts errors:180-718 | Error telemetry (refactor) | Same error codes as main hook | Maintenance burden doubled if both paths active |
| adLogic.ts:1-220 | Legacy ad logic draft | Example listeners calling `FirebaseAnalytics.ad` for generic/level_up/game_over/rewarded placements and `FirebaseAnalytics.reward('EXTRA_LIFE', ...)`; errors such as `ad_load_error`, `rewarded_resume_critical` | Commented template, not wired into app; analytics schema must stay aligned with live hooks to avoid drift |
| Global (repo-wide) | Missing integrations | — | No implementation found for Crashlytics, Performance Monitoring, Remote Config, A/B testing, attribution (install referrer, dynamic links, UTM), or notification analytics |

## Lacunes observées
- Aucune intégration Crashlytics/Performance : toutes les erreurs passent par l’événement Analytics `error_occurred`, sans stack trace native ni regroupement de sévérité.
- Le flux UMP est présent mais neutralisé dans `_layout` (`canShowPersonalizedAds=false`), donc aucun suivi ni persistance du consentement réel.
- Les événements récurrents (`login_failed`, `signup_failed`, `life_lost`, `user_logout`) utilisent des schémas de paramètres variables, ce qui complexifie l’analyse et l’A/B testing.
- Les sorties arrière-plan et pertes de vie sont journalisées à plusieurs niveaux (`useAppStateDetection`, `usePrecisionGame`, `useGameLogicA`), d’où un risque de double comptage.
- Absence totale d’instrumentation pour notifications, attribution (referrer/UTM/dynamic links) et Remote Config/A-B tests.
- Le statut de consentement n’est pas stocké durablement ni corrélé aux événements utilisateurs (aucune propriété utilisateur dédiée).
- Les événements `ad_event` reposent uniquement sur des chaînes `ad_placement`/`ad_action`, sans métriques de revenus ou normalisation entre modules précision/classique.
- Les fichiers hérités (`adLogic.ts`, `useGameLogicA.refactored.ts`) dupliquent la télémétrie et peuvent diverger du comportement réellement exécuté.

## Hot Spots
1. `lib/firebase.ts` – point central définissant les noms d’événements, propriétés utilisateur et stratégie d’erreurs.
2. `hooks/game/useAds.ts` – bloc le plus verbeux pour les publicités, sensible aux régressions et aux doublons.
3. `hooks/game/usePrecisionGame.ts` – mesure complète du mode Précision (pénalités, continue, game over).
4. `app/(tabs)/index.tsx` – entonnoir d’entrée (splash, login, invité) et bannière AdMob.
5. `app/auth/login.tsx` – multiplexage des échecs de connexion (mot de passe + Google) avec schémas hétérogènes.
6. `app/auth/signup.tsx` – instrumentation fine des erreurs d’inscription et des succès différés.
7. `hooks/useGameLogicA.ts` – boucle de jeu principale classique, incluant leaderboard et erreurs critiques.
8. `hooks/game/usePrecisionAds.ts` – gestion des publicités continue/game over en mode Précision.
9. `hooks/useAudio.ts` (et variante `hooks/game/usePrecisionAudio.ts`) – télémétrie audio et erreurs potentielles en rafale.
10. `app/_layout.tsx` – initialisation globale Analytics + AdMob, et point de contrôle du consentement.
