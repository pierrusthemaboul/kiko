<!DOCTYPE html>
<html lang="fr" style="height: 100%;">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kiko - Super Remote</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --primary: #3b82f6;
            --success: #22c55e;
            --accent: #f59e0b;
            --ai-bg: #1e1b4b;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
        }

        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: var(--card);
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            opacity: 0.5;
        }

        .tab.active {
            opacity: 1;
            background: var(--primary);
        }

        .view {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .view.active {
            display: flex;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--primary);
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .console {
            flex: 1;
            background-color: #000;
            border-radius: 8px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-y: auto;
            border: 1px solid #334155;
            color: #10b981;
            white-space: pre-wrap;
        }

        .chat-container {
            flex: 1;
            background: var(--ai-bg);
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg {
            max-width: 85%;
            padding: 10px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
        }

        .msg.user {
            align-self: flex-end;
            background: var(--primary);
        }

        .msg.bot {
            align-self: flex-start;
            background: var(--card);
            border-left: 4px solid var(--accent);
        }

        .input-area {
            display: flex;
            gap: 8px;
            padding: 10px;
            background: var(--card);
            border-radius: 12px;
            margin-top: 10px;
        }

        input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #334155;
            background: #0f172a;
            color: white;
            font-size: 16px !important;
        }

        .send-btn {
            background: var(--success);
            padding: 0 15px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #94a3b8;
            padding: 5px;
        }
    </style>
</head>

<body>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('machine')">‚öôÔ∏è Machine</div>
        <div class="tab" id="ai-tab-btn" onclick="switchTab('ai')">üß† Antigravity</div>
    </div>

    <!-- VUE MACHINE -->
    <div id="view-machine" class="view active">
        <div class="controls">
            <button onclick="sendCommand('bureau')">üìÅ Bureau</button>
            <button style="background:var(--accent)" onclick="sendCommand('chambre')">üì∑ Chambre</button>
            <button style="background:var(--success); grid-column: span 2;" onclick="sendCommand('migration')">üö¢
                Migration IA</button>
        </div>
        <div id="console" class="console">Pr√™t pour les commandes...</div>
    </div>

    <!-- VUE AI -->
    <div id="view-ai" class="view">
        <div id="chat-box" class="chat-container">
            <div class="msg bot">Bonjour Pierre ! Je suis Antigravity. Je t'√©coute, m√™me √† distance.</div>
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="√âcrire ici..." autocomplete="off">
        <button class="send-btn" id="send-btn">OK</button>
    </div>

    <div class="status-bar">
        <span id="connection-status">Connexion...</span>
        <span>v2.0 Turbo</span>
    </div>

    <script>
        const SUPABASE_URL = 'https://ppxmtnuewcixbbmhnzzc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBweG10bnVld2NpeGJibWhuenpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjY4OTkxMjcsImV4cCI6MjA0MjQ3NTEyN30.0z2be74E3db-XvyIKXPlogI__9Ric1Il4cZ1Fs7TJ5U';

        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentSession = 'sess_global_' + Date.now();
        let currentTab = 'machine';

        document.getElementById('connection-status').innerText = 'üü¢ Connect√©';
        document.getElementById('connection-status').style.color = '#22c55e';

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            if (tab === 'machine') {
                document.getElementById('view-machine').classList.add('active');
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('user-input').placeholder = "R√©pondre au script...";
            } else {
                document.getElementById('view-ai').classList.add('active');
                document.getElementById('ai-tab-btn').classList.add('active');
                document.getElementById('user-input').placeholder = "Parler √† Antigravity...";
            }
        }

        async function sendCommand(cmd) {
            currentSession = 'sess_' + Date.now();
            switchTab('machine');
            document.getElementById('console').innerText = `\n> Lancement de ${cmd}...\n`;
            await _supabase.from('remote_control').insert({ type: 'command', content: cmd, session_id: currentSession });
        }

        async function handleGlobalSend() {
            const inputField = document.getElementById('user-input');
            const val = inputField.value;
            if (!val) return;

            if (currentTab === 'machine') {
                await _supabase.from('remote_control').insert({ type: 'input', content: val, session_id: currentSession });
                document.getElementById('console').innerText += `\n>> ${val}\n`;
            } else {
                // Mode AI Chat
                appendMsg(val, 'user');
                await _supabase.from('ai_chat').insert({ role: 'user', content: val, session_id: 'mobile_session' });
            }
            inputField.value = '';
            inputField.blur();
        }

        function appendMsg(text, role) {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg ${role === 'user' ? 'user' : 'bot'}`;
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        document.getElementById('send-btn').onclick = handleGlobalSend;
        document.getElementById('user-input').onkeypress = (e) => { if (e.key === 'Enter') handleGlobalSend(); };

        // √âcoute Realtime Machine
        _supabase.channel('machine_out').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'remote_control' }, payload => {
            if (payload.new.type === 'output') {
                const con = document.getElementById('console');
                con.innerText += payload.new.content;
                con.scrollTop = con.scrollHeight;
            }
        }).subscribe();

        // √âcoute Realtime AI
        _supabase.channel('ai_in').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'ai_chat' }, payload => {
            if (payload.new.role === 'assistant') {
                appendMsg(payload.new.content, 'bot');
            }
        }).subscribe();
    </script>
</body>

</html>